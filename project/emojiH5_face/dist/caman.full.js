/*
  CompoundBlur - Blurring with varying radii for Canvas
  
  Version:   0.1
  Author:  Mario Klingemann
  Contact:   mario@quasimondo.com
  Website:  http://www.quasimondo.com/StackBlurForCanvas
  Twitter:  @quasimondo
  Modified By: Ryan LeFevre (@meltingice)
  
  In case you find this class useful - especially in commercial projects -
  I am not totally unhappy for a small donation to my PayPal account
  mario@quasimondo.de
  
  Copyright (c) 2011 Mario Klingemann
  
  Permission is hereby granted, free of charge, to any person
  obtaining a copy of this software and associated documentation
  files (the "Software"), to deal in the Software without
  restriction, including without limitation the rights to use,
  copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the
  Software is furnished to do so, subject to the following
  conditions:
  
  The above copyright notice and this permission notice shall be
  included in all copies or substantial portions of the Software.
  
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
  OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
  HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
  WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
  OTHER DEALINGS IN THE SOFTWARE.
  */

/*
  StackBlur - a fast almost Gaussian Blur For Canvas v0.31 modified for CamanJS
  
  Version:   0.31
  Author:    Mario Klingemann
  Contact:   mario@quasimondo.com
  Website:  http://www.quasimondo.com/StackBlurForCanvas
  Twitter:  @quasimondo
  Modified By: Ryan LeFevre (@meltingice)
  
  In case you find this class useful - especially in commercial projects -
  I am not totally unhappy for a small donation to my PayPal account
  mario@quasimondo.de
  
  Or support me on flattr: 
  https://flattr.com/thing/72791/StackBlur-a-fast-almost-Gaussian-Blur-Effect-for-CanvasJavascript
  
  Copyright (c) 2010 Mario Klingemann
  
  Permission is hereby granted, free of charge, to any person
  obtaining a copy of this software and associated documentation
  files (the "Software"), to deal in the Software without
  restriction, including without limitation the rights to use,
  copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the
  Software is furnished to do so, subject to the following
  conditions:
  
  The above copyright notice and this permission notice shall be
  included in all copies or substantial portions of the Software.
  
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
  OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
  HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
  WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
  OTHER DEALINGS IN THE SOFTWARE.
  */

(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z={}.hasOwnProperty,A=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1},B=[].slice,C=this;x=Array.prototype.slice,a=function(a,b){return b==null&&(b=document),typeof a=="object"||typeof exports!="undefined"&&exports!==null?a:b.querySelector(a)},v=function(){function a(){}return a.uniqid=function(){var a;return a=0,{get:function(){return a++}}}(),a.extend=function(a){var b,c,d,e,f,g;c=a,e=x.call(arguments,1);for(f=0,g=e.length;f<g;f++){b=e[f];for(d in b){if(!z.call(b,d))continue;c[d]=b[d]}}return c},a.clampRGB=function(a){return a<0?0:a>255?255:a},a.copyAttributes=function(a,b,c){var d,e,f,g,h,i;c==null&&(c={}),g=a.attributes,i=[];for(e=0,f=g.length;e<f;e++){d=g[e];if(c.except!=null&&(h=d.nodeName,A.call(c.except,h)>=0))continue;i.push(b.setAttribute(d.nodeName,d.nodeValue))}return i},a.dataArray=function(a){return a==null&&(a=0),e.NodeJS||window.Uint8Array!=null?new Uint8Array(a):new Array(a)},a}(),typeof exports!="undefined"&&exports!==null?(t=exports,g=require("canvas"),m=g.Image,j=require("fibers"),w=require("fs")):t=window,t.Caman=e=function(){function c(){var a,d,e,f=this;if(arguments.length===0)throw"Invalid arguments";if(this instanceof c){this.finishInit=this.finishInit.bind(this),this.imageLoaded=this.imageLoaded.bind(this),a=arguments[0];if(!c.NodeJS){e=parseInt(c.getAttrId(a[0]),10),d=typeof a[1]=="function"?a[1]:typeof a[2]=="function"?a[2]:function(){};if(!isNaN(e)&&u.has(e))return u.execute(e,d)}return this.id=v.uniqid.get(),this.initializedPixelData=this.originalPixelData=null,this.cropCoordinates={x:0,y:0},this.cropped=!1,this.resized=!1,this.pixelStack=[],this.layerStack=[],this.canvasQueue=[],this.currentLayer=null,this.scaled=!1,this.analyze=new b(this),this.renderer=new s(this),this.domIsLoaded(function(){return f.parseArguments(a),f.setup()}),this}return new c(arguments)}return c.version={release:"4.1.1",date:"4/8/2013"},c.DEBUG=!1,c.NodeJS=typeof exports!="undefined"&&exports!==null,c.autoload=!c.NodeJS,c.allowRevert=!0,c.crossOrigin="anonymous",c.toString=function(){return"Version "+c.version.release+", Released "+c.version.date},c.remoteProxy="",c.proxyParam="camanProxyUrl",c.getAttrId=function(b){return c.NodeJS?!0:(typeof b=="string"&&(b=a(b)),b==null||b.getAttribute==null?null:b.getAttribute("data-caman-id"))},c.prototype.domIsLoaded=function(a){var b,d=this;return c.NodeJS?setTimeout(function(){return a.call(d)},0):document.readyState==="complete"?(o.debug("DOM initialized"),setTimeout(function(){return a.call(d)},0)):(b=function(){if(document.readyState==="complete")return o.debug("DOM initialized"),a.call(d)},document.addEventListener("readystatechange",b,!1))},c.prototype.parseArguments=function(a){var b,c,d,e;if(a.length===0)throw"Invalid arguments given";this.initObj=null,this.initType=null,this.imageUrl=null,this.callback=function(){},this.setInitObject(a[0]);if(a.length===1)return;switch(typeof a[1]){case"string":this.imageUrl=a[1];break;case"function":this.callback=a[1]}if(a.length===2)return;this.callback=a[2];if(a.length===4){d=a[4],e=[];for(b in d){if(!z.call(d,b))continue;c=d[b],e.push(this.options[b]=c)}return e}},c.prototype.setInitObject=function(b){if(c.NodeJS){this.initObj=b,this.initType="node";return}typeof b=="object"?this.initObj=b:this.initObj=a(b);if(this.initObj==null)throw"Could not find image or canvas for initialization.";return this.initType=this.initObj.nodeName.toLowerCase()},c.prototype.setup=function(){switch(this.initType){case"node":return this.initNode();case"img":return this.initImage();case"canvas":return this.initCanvas()}},c.prototype.initNode=function(){var a=this;return o.debug("Initializing for NodeJS"),this.image=new m,this.image.onload=function(){return o.debug("Image loaded. Width = "+a.imageWidth()+", Height = "+a.imageHeight()),a.canvas=new g(a.imageWidth(),a.imageHeight()),a.finishInit()},this.image.onerror=function(a){throw a},this.image.src=this.initObj},c.prototype.initImage=function(){return this.image=this.initObj,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),v.copyAttributes(this.image,this.canvas,{except:["src"]}),this.image.parentNode.replaceChild(this.canvas,this.image),this.imageAdjustments(),this.waitForImageLoaded()},c.prototype.initCanvas=function(){return this.canvas=this.initObj,this.context=this.canvas.getContext("2d"),this.imageUrl!=null?(this.image=document.createElement("img"),this.image.src=this.imageUrl,this.imageAdjustments(),this.waitForImageLoaded()):this.finishInit()},c.prototype.imageAdjustments=function(){this.needsHiDPISwap()&&(o.debug(this.image.src,"->",this.hiDPIReplacement()),this.swapped=!0,this.image.src=this.hiDPIReplacement());if(l.isRemote(this.image))return this.image.src=l.proxyUrl(this.image.src),o.debug("Remote image detected, using URL = "+this.image.src)},c.prototype.waitForImageLoaded=function(){return this.isImageLoaded()?this.imageLoaded():this.image.onload=this.imageLoaded},c.prototype.isImageLoaded=function(){return this.image.complete?this.image.naturalWidth!=null&&this.image.naturalWidth===0?!1:!0:!1},c.prototype.imageWidth=function(){return this.image.width||this.image.naturalWidth},c.prototype.imageHeight=function(){return this.image.height||this.image.naturalHeight},c.prototype.imageLoaded=function(){return o.debug("Image loaded. Width = "+this.imageWidth()+", Height = "+this.imageHeight()),this.swapped?(this.canvas.width=this.imageWidth()/this.hiDPIRatio(),this.canvas.height=this.imageHeight()/this.hiDPIRatio()):(this.canvas.width=this.imageWidth(),this.canvas.height=this.imageHeight()),this.finishInit()},c.prototype.finishInit=function(){var a,b,d,e,f;this.context==null&&(this.context=this.canvas.getContext("2d")),this.originalWidth=this.preScaledWidth=this.width=this.canvas.width,this.originalHeight=this.preScaledHeight=this.height=this.canvas.height,this.hiDPIAdjustments(),this.hasId()||this.assignId(),this.image!=null&&this.context.drawImage(this.image,0,0,this.imageWidth(),this.imageHeight(),0,0,this.preScaledWidth,this.preScaledHeight),this.reloadCanvasData();if(c.allowRevert){this.initializedPixelData=v.dataArray(this.pixelData.length),this.originalPixelData=v.dataArray(this.pixelData.length),f=this.pixelData;for(a=d=0,e=f.length;d<e;a=++d)b=f[a],this.initializedPixelData[a]=b,this.originalPixelData[a]=b}return this.dimensions={width:this.canvas.width,height:this.canvas.height},u.put(this.id,this),this.callback.call(this,this),this.callback=function(){}},c.prototype.reloadCanvasData=function(){return this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data},c.prototype.resetOriginalPixelData=function(){var a,b,d,e,f;if(!c.allowRevert)throw"Revert disabled";this.originalPixelData=v.dataArray(this.pixelData.length),e=this.pixelData,f=[];for(b=0,d=e.length;b<d;b++)a=e[b],f.push(this.originalPixelData.push(a));return f},c.prototype.hasId=function(){return c.getAttrId(this.canvas)!=null},c.prototype.assignId=function(){if(c.NodeJS||this.canvas.getAttribute("data-caman-id"))return;return this.canvas.setAttribute("data-caman-id",this.id)},c.prototype.hiDPIDisabled=function(){return this.canvas.getAttribute("data-caman-hidpi-disabled")!==null},c.prototype.hiDPIAdjustments=function(){var a;if(c.NodeJS||this.hiDPIDisabled())return;a=this.hiDPIRatio();if(a!==1)return o.debug("HiDPI ratio = "+a),this.scaled=!0,this.preScaledWidth=this.canvas.width,this.preScaledHeight=this.canvas.height,this.canvas.width=this.preScaledWidth*a,this.canvas.height=this.preScaledHeight*a,this.canvas.style.width=""+this.preScaledWidth+"px",this.canvas.style.height=""+this.preScaledHeight+"px",this.context.scale(a,a),this.width=this.originalWidth=this.canvas.width,this.height=this.originalHeight=this.canvas.height},c.prototype.hiDPIRatio=function(){var a,b;return b=window.devicePixelRatio||1,a=this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1,b/a},c.prototype.hiDPICapable=function(){return window.devicePixelRatio!=null&&window.devicePixelRatio!==1},c.prototype.needsHiDPISwap=function(){return this.hiDPIDisabled()||!this.hiDPICapable()?!1:this.hiDPIReplacement()!==null},c.prototype.hiDPIReplacement=function(){return this.image==null?null:this.image.getAttribute("data-caman-hidpi")},c.prototype.replaceCanvas=function(a){var b;return b=this.canvas,this.canvas=a,this.context=this.canvas.getContext("2d"),b.parentNode.replaceChild(this.canvas,b),this.width=this.canvas.width,this.height=this.canvas.height,this.reloadCanvasData(),this.dimensions={width:this.canvas.width,height:this.canvas.height}},c.prototype.render=function(a){var b=this;return a==null&&(a=function(){}),i.trigger(this,"renderStart"),this.renderer.execute(function(){return b.context.putImageData(b.imageData,0,0),a.call(b)})},c.prototype.revert=function(){var a,b,d,e,f;if(!c.allowRevert)throw"Revert disabled";f=this.originalVisiblePixels();for(a=d=0,e=f.length;d<e;a=++d)b=f[a],this.pixelData[a]=b;return this.context.putImageData(this.imageData,0,0)},c.prototype.reset=function(){var a,b,c,d,e,f,g,h,i;a=document.createElement("canvas"),v.copyAttributes(this.canvas,a),a.width=this.originalWidth,a.height=this.originalHeight,b=a.getContext("2d"),d=b.getImageData(0,0,a.width,a.height),f=d.data,i=this.initializedPixelData;for(c=g=0,h=i.length;g<h;c=++g)e=i[c],f[c]=e;return b.putImageData(d,0,0),this.cropCoordinates={x:0,y:0},this.resized=!1,this.replaceCanvas(a)},c.prototype.originalVisiblePixels=function(){var a,b,d,e,f,g,h,i,j,k,l,m,n,o,p,r,s,t,u,v,w;if(!c.allowRevert)throw"Revert disabled";k=[],m=this.cropCoordinates.x,e=m+this.width,n=this.cropCoordinates.y,f=n+this.height;if(this.resized){a=document.createElement("canvas"),a.width=this.originalWidth,a.height=this.originalHeight,d=a.getContext("2d"),h=d.getImageData(0,0,a.width,a.height),j=h.data,t=this.originalPixelData;for(g=p=0,s=t.length;p<s;g=++p)i=t[g],j[g]=i;d.putImageData(h,0,0),l=document.createElement("canvas"),l.width=this.width,l.height=this.height,d=l.getContext("2d"),d.drawImage(a,0,0,this.originalWidth,this.originalHeight,0,0,this.width,this.height),j=d.getImageData(0,0,this.width,this.height).data,o=this.width}else j=this.originalPixelData,o=this.originalWidth;for(g=r=0,u=j.length;r<u;g=r+=4)b=q.locationToCoordinates(g,o),m<=(v=b.x)&&v<e&&n<=(w=b.y)&&w<f&&k.push(j[g],j[g+1],j[g+2],j[g+3]);return k},c.prototype.process=function(a,b){return this.renderer.add({type:k.Type.Single,name:a,processFn:b}),this},c.prototype.processKernel=function(a,b,c,d){var e,f,g;if(!c){c=0;for(e=f=0,g=b.length;0<=g?f<g:f>g;e=0<=g?++f:--f)c+=b[e]}return this.renderer.add({type:k.Type.Kernel,name:a,adjust:b,divisor:c,bias:d||0}),this},c.prototype.processPlugin=function(a,b){return this.renderer.add({type:k.Type.Plugin,plugin:a,args:b}),this},c.prototype.newLayer=function(a){var b;return b=new n(this),this.canvasQueue.push(b),this.renderer.add({type:k.Type.LayerDequeue}),a.call(b),this.renderer.add({type:k.Type.LayerFinished}),this},c.prototype.executeLayer=function(a){return this.pushContext(a)},c.prototype.pushContext=function(a){return this.layerStack.push(this.currentLayer),this.pixelStack.push(this.pixelData),this.currentLayer=a,this.pixelData=a.pixelData},c.prototype.popContext=function(){return this.pixelData=this.pixelStack.pop(),this.currentLayer=this.layerStack.pop()},c.prototype.applyCurrentLayer=function(){return this.currentLayer.applyToParent()},c}(),b=function(){function a(a){this.c=a}return a.prototype.calculateLevels=function(){var a,b,c,d,e,f,g;b={r:{},g:{},b:{}};for(a=d=0;d<=255;a=++d)b.r[a]=0,b.g[a]=0,b.b[a]=0;for(a=e=0,g=this.c.pixelData.length;e<g;a=e+=4)b.r[this.c.pixelData[a]]++,b.g[this.c.pixelData[a+1]]++,b.b[this.c.pixelData[a+2]]++;c=this.c.pixelData.length/4;for(a=f=0;f<=255;a=++f)b.r[a]/=c,b.g[a]/=c,b.b[a]/=c;return b},a}(),e.DOMUpdated=function(){var a,b,c,d,e,g;b=document.querySelectorAll("img[data-caman]");if(b.length>0){g=[];for(d=0,e=b.length;d<e;d++)a=b[d],g.push(c=new f(a,function(){return this.parse(),this.execute()}));return g}return},e.autoload&&function(){return document.readyState==="complete"?e.DOMUpdated():document.addEventListener("DOMContentLoaded",e.DOMUpdated,!1)}(),f=function(){function a(a,b){this.dataStr=a.getAttribute("data-caman"),this.caman=e(a,b.bind(this))}var b;return b="(\\w+)\\((.*?)\\)",a.prototype.parse=function(){var a,c,d,e,f,g,h,i,j,k,l,m;this.ele=this.caman.canvas,h=new RegExp(b,"g"),i=this.dataStr.match(h);if(i.length>0){h=new RegExp(b),m=[];for(j=0,k=i.length;j<k;j++){e=i[j],l=e.match(h),g=l[0],c=l[1],a=l[2],f=new Function("return function() {        this."+c+"("+a+");      };");try{d=f(),m.push(d.call(this.caman))}catch(n){m.push(o.debug(n))}}return m}return},a.prototype.execute=function(){var a;return a=this.ele,this.caman.render(function(){return a.parentNode.replaceChild(this.toImage(),a)})},a}(),e.Blender=c=function(){function a(){}return a.blenders={},a.register=function(a,b){return this.blenders[a]=b},a.execute=function(a,b,c){return this.blenders[a](b,c)},a}(),e.Calculate=d=function(){function a(){}return a.distance=function(a,b,c,d){return Math.sqrt(Math.pow(c-a,2)+Math.pow(d-b,2))},a.randomRange=function(a,b,c){var d;return c==null&&(c=!1),d=a+Math.random()*(b-a),c?d.toFixed(c):Math.round(d)},a.luminance=function(a){return.299*a.r+.587*a.g+.114*a.b},a.bezier=function(a,b,c,d,e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G;u=a[0],y=a[1],v=b[0],z=b[1],w=c[0],A=c[1],x=d[0],B=d[1],m={},k=parseInt(3*(v-u),10),i=3*(w-v)-k,g=x-u-k-i,l=3*(z-y),j=3*(A-z)-l,h=B-y-l-j;for(p=C=0;C<1e3;p=++C)t=p/1e3,n=Math.round(g*Math.pow(t,3)+i*Math.pow(t,2)+k*t+u),o=Math.round(h*Math.pow(t,3)+j*Math.pow(t,2)+l*t+y),e&&o<e?o=e:f&&o>f&&(o=f),m[n]=o;if(m.length<d[0]+1)for(p=D=0,F=d[0];0<=F?D<=F:D>=F;p=0<=F?++D:--D)if(m[p]==null){r=[p-1,m[p-1]];for(q=E=p,G=d[0];p<=G?E<=G:E>=G;q=p<=G?++E:--E)if(m[q]!=null){s=[q,m[q]];break}m[p]=r[1]+(s[1]-r[1])/(s[0]-r[0])*(p-r[0])}return m[d[0]]==null&&(m[d[0]]=m[d[0]-1]),m},a}(),h=function(){function a(){}return a.hexToRGB=function(a){var b,c,d;return a.charAt(0)==="#"&&(a=a.substr(1)),d=parseInt(a.substr(0,2),16),c=parseInt(a.substr(2,2),16),b=parseInt(a.substr(4,2),16),{r:d,g:c,b:b}},a.rgbToHSL=function(a,b,c){var d,e,f,g,h,i;return typeof a=="object"&&(b=a.g,c=a.b,a=a.r),a/=255,b/=255,c/=255,g=Math.max(a,b,c),h=Math.min(a,b,c),f=(g+h)/2,g===h?e=i=0:(d=g-h,i=f>.5?d/(2-g-h):d/(g+h),e=function(){switch(g){case a:return(b-c)/d+(b<c?6:0);case b:return(c-a)/d+2;case c:return(a-b)/d+4}}(),e/=6),{h:e,s:i,l:f}},a.hslToRGB=function(a,b,c){var d,e,f,g,h;return typeof a=="object"&&(b=a.s,c=a.l,a=a.h),b===0?h=e=d=c:(g=c<.5?c*(1+b):c+b-c*b,f=2*c-g,h=this.hueToRGB(f,g,a+1/3),e=this.hueToRGB(f,g,a),d=this.hueToRGB(f,g,a-1/3)),{r:h*255,g:e*255,b:d*255}},a.hueToRGB=function(a,b,c){return c<0&&(c+=1),c>1&&(c-=1),c<1/6?a+(b-a)*6*c:c<.5?b:c<2/3?a+(b-a)*(2/3-c)*6:a},a.rgbToHSV=function(a,b,c){var d,e,f,g,h,i;return a/=255,b/=255,c/=255,f=Math.max(a,b,c),g=Math.min(a,b,c),i=f,d=f-g,h=f===0?0:d/f,f===g?e=0:(e=function(){switch(f){case a:return(b-c)/d+(b<c?6:0);case b:return(c-a)/d+2;case c:return(a-b)/d+4}}(),e/=6),{h:e,s:h,v:i}},a.hsvToRGB=function(a,b,c){var d,e,f,g,h,i,j,k;g=Math.floor(a*6),e=a*6-g,h=c*(1-b),i=c*(1-e*b),k=c*(1-(1-e)*b);switch(g%6){case 0:j=c,f=k,d=h;break;case 1:j=i,f=c,d=h;break;case 2:j=h,f=c,d=k;break;case 3:j=h,f=i,d=c;break;case 4:j=k,f=h,d=c;break;case 5:j=c,f=h,d=i}return{r:j*255,g:f*255,b:d*255}},a.rgbToXYZ=function(a,b,c){var d,e,f;return a/=255,b/=255,c/=255,a>.04045?a=Math.pow((a+.055)/1.055,2.4):a/=12.92,b>.04045?b=Math.pow((b+.055)/1.055,2.4):b/=12.92,c>.04045?c=Math.pow((c+.055)/1.055,2.4):c/=12.92,d=a*.4124+b*.3576+c*.1805,e=a*.2126+b*.7152+c*.0722,f=a*.0193+b*.1192+c*.9505,{x:d*100,y:e*100,z:f*100}},a.xyzToRGB=function(a,b,c){var d,e,f;return a/=100,b/=100,c/=100,f=3.2406*a+ -1.5372*b+ -0.4986*c,e=-0.9689*a+1.8758*b+.0415*c,d=.0557*a+ -0.204*b+1.057*c,f>.0031308?f=1.055*Math.pow(f,.4166666667)-.055:f*=12.92,e>.0031308?e=1.055*Math.pow(e,.4166666667)-.055:e*=12.92,d>.0031308?d=1.055*Math.pow(d,.4166666667)-.055:d*=12.92,{r:f*255,g:e*255,b:d*255}},a.xyzToLab=function(a,b,c){var d,e,f,g,h,i;return typeof a=="object"&&(b=a.y,c=a.z,a=a.x),g=95.047,h=100,i=108.883,a/=g,b/=h,c/=i,a>.008856451679?a=Math.pow(a,.3333333333):a=7.787037037*a+.1379310345,b>.008856451679?b=Math.pow(b,.3333333333):b=7.787037037*b+.1379310345,c>.008856451679?c=Math.pow(c,.3333333333):c=7.787037037*c+.1379310345,f=116*b-16,d=500*(a-b),e=200*(b-c),{l:f,a:d,b:e}},a.labToXYZ=function(a,b,c){var d,e,f;return typeof a=="object"&&(b=a.a,c=a.b,a=a.l),e=(a+16)/116,d=e+b/500,f=e-c/200,d>.2068965517?d=d*d*d:d=.1284185493*(d-.1379310345),e>.2068965517?e=e*e*e:e=.1284185493*(e-.1379310345),f>.2068965517?f=f*f*f:f=.1284185493*(f-.1379310345),{x:d*95.047,y:e*100,z:f*108.883}},a.rgbToLab=function(a,b,c){var d;return typeof a=="object"&&(b=a.g,c=a.b,a=a.r),d=this.rgbToXYZ(a,b,c),this.xyzToLab(d)},a.labToRGB=function(a,b,c){},a}(),i=function(){function a(){}return a.events={},a.types=["processStart","processComplete","renderStart","renderFinished","blockStarted","blockFinished"],a.trigger=function(a,b,c){var d,e,f,g,h;if(this.events[b]&&this.events[b].length){g=this.events[b],h=[];for(e=0,f=g.length;e<f;e++)d=g[e],d.target===null||a.id===d.target.id?h.push(d.fn.call(a,c)):h.push(void 0);return h}},a.listen=function(a,b,c){var d,e;return typeof a=="string"&&(e=a,d=b,a=null,b=e,c=d),A.call(this.types,b)<0?!1:(this.events[b]||(this.events[b]=[]),this.events[b].push({target:a,fn:c}),!0)},a}(),e.Event=i,e.Filter=k=function(){function a(){}return a.Type={Single:1,Kernel:2,LayerDequeue:3,LayerFinished:4,LoadOverlay:5,Plugin:6},a.register=function(a,b){return e.prototype[a]=b},a}(),e.IO=l=function(){function a(){}return a.domainRegex=/(?:(?:http|https):\/\/)((?:\w+)\.(?:(?:\w|\.)+))/,a.isRemote=function(a){return a==null?!1:this.corsEnabled(a)?!1:this.isURLRemote(a.src)},a.corsEnabled=function(a){var b;return a.crossOrigin!=null&&((b=a.crossOrigin.toLowerCase())==="anonymous"||b==="use-credentials")},a.isURLRemote=function(a){var b;return b=a.match(this.domainRegex),b?b[1]!==document.domain:!1},a.remoteCheck=function(a){if(this.isURLRemote(a)){if(!!e.remoteProxy.length){if(e.isURLRemote(e.remoteProxy)){o.info("Cannot use a remote proxy for loading images.");return}return""+e.remoteProxy+"?camanProxyUrl="+encodeURIComponent(a)}o.info("Attempting to load a remote image without a configured proxy. URL: "+a)}},a.proxyUrl=function(a){return""+e.remoteProxy+"?"+e.proxyParam+"="+encodeURIComponent(a)},a.useProxy=function(a){var b;return b={ruby:"rb",python:"py",perl:"pl",javascript:"js"},a=a.toLowerCase(),b[a]!=null&&(a=b[a]),"proxies/caman_proxy."+a},a}(),e.prototype.save=function(){return typeof exports!="undefined"&&exports!==null?this.nodeSave.apply(this,arguments):this.browserSave.apply(this,arguments)},e.prototype.browserSave=function(a){var b;return a==null&&(a="png"),a=a.toLowerCase(),b=this.toBase64(a).replace("image/"+a,"image/octet-stream"),document.location.href=b},e.prototype.nodeSave=function(a,b){var c;b==null&&(b=!0);try{c=w.statSync(a);if(c.isFile()&&!b)return!1}catch(d){o.debug("Creating output file "+a)}return w.writeFile(a,this.canvas.toBuffer(),function(){return o.debug("Finished writing to "+a)})},e.prototype.toImage=function(a){var b;return b=document.createElement("img"),b.src=this.toBase64(a),b.width=this.dimensions.width,b.height=this.dimensions.height,window.devicePixelRatio&&(b.width/=window.devicePixelRatio,b.height/=window.devicePixelRatio),b},e.prototype.toBase64=function(a){return a==null&&(a="png"),a=a.toLowerCase(),this.canvas.toDataURL("image/"+a)},n=function(){function b(a){this.c=a,this.filter=this.c,this.options={blendingMode:"normal",opacity:1},this.layerID=v.uniqid.get(),this.canvas=typeof exports!="undefined"&&exports!==null?new g:document.createElement("canvas"),this.canvas.width=this.c.dimensions.width,this.canvas.height=this.c.dimensions.height,this.context=this.canvas.getContext("2d"),this.context.createImageData(this.canvas.width,this.canvas.height),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data}return b.prototype.newLayer=function(a){return this.c.newLayer.call(this.c,a)},b.prototype.setBlendingMode=function(a){return this.options.blendingMode=a,this},b.prototype.opacity=function(a){return this.options.opacity=a/100,this},b.prototype.copyParent=function(){var a,b,c,d;b=this.c.pixelData;for(a=c=0,d=this.c.pixelData.length;c<d;a=c+=4)this.pixelData[a]=b[a],this.pixelData[a+1]=b[a+1],this.pixelData[a+2]=b[a+2],this.pixelData[a+3]=b[a+3];return this},b.prototype.fillColor=function(){return this.c.fillColor.apply(this.c,arguments)},b.prototype.overlayImage=function(b){return typeof b=="object"?b=b.src:typeof b=="string"&&b[0]==="#"&&(b=a(b).src),b?(this.c.renderer.renderQueue.push({type:k.Type.LoadOverlay,src:b,layer:this}),this):this},b.prototype.applyToParent=function(){var a,b,d,e,f,g,h,i,j;d=this.c.pixelStack[this.c.pixelStack.length-1],b=this.c.pixelData,j=[];for(a=h=0,i=b.length;h<i;a=h+=4)g={r:d[a],g:d[a+1],b:d[a+2],a:d[a+3]},f={r:b[a],g:b[a+1],b:b[a+2],a:b[a+3]},e=c.execute(this.options.blendingMode,f,g),e.r=v.clampRGB(e.r),e.g=v.clampRGB(e.g),e.b=v.clampRGB(e.b),e.a==null&&(e.a=f.a),d[a]=g.r-(g.r-e.r)*this.options.opacity*(e.a/255),d[a+1]=g.g-(g.g-e.g)*this.options.opacity*(e.a/255),j.push(d[a+2]=g.b-(g.b-e.b)*this.options.opacity*(e.a/255));return j},b}(),p=function(){function a(){var a,b,c,d;d=["log","info","warn","error"];for(b=0,c=d.length;b<c;b++)a=d[b],this[a]=function(a){return function(){var b;b=1<=arguments.length?B.call(arguments,0):[];if(!e.DEBUG)return;try{return console[a].apply(console,b)}catch(c){return console[a](b)}}}(a);this.debug=this.log}return a}(),o=new p,q=function(){function a(a){this.c=a,this.loc=0}return a.coordinatesToLocation=function(a,b,c){return(b*c+a)*4},a.locationToCoordinates=function(a,b){var c,d;return d=Math.floor(a/(b*4)),c=a%(b*4)/4,{x:c,y:d}},a.prototype.locationXY=function(){var a,b;return b=this.c.dimensions.height-Math.floor(this.loc/(this.c.dimensions.width*4)),a=this.loc%(this.c.dimensions.width*4)/4,{x:a,y:b}},a.prototype.getPixelRelative=function(a,b){var c;return c=this.loc+this.c.dimensions.width*4*b*-1+4*a,c>this.c.pixelData.length||c<0?{r:0,g:0,b:0,a:0}:{r:this.c.pixelData[c],g:this.c.pixelData[c+1],b:this.c.pixelData[c+2],a:this.c.pixelData[c+3]}},a.prototype.putPixelRelative=function(a,b,c){var d;d=this.loc+this.c.dimensions.width*4*b*-1+4*a;if(newLoc>this.c.pixelData.length||newLoc<0)return;return this.c.pixelData[newLoc]=c.r,this.c.pixelData[newLoc+1]=c.g,this.c.pixelData[newLoc+2]=c.b,this.c.pixelData[newLoc+3]=c.a,!0},a.prototype.getPixel=function(a,b){var c;return c=this.coordinatesToLocation(a,b,this.width),{r:this.c.pixelData[c],g:this.c.pixelData[c+1],b:this.c.pixelData[c+2],a:this.c.pixelData[c+3]}},a.prototype.putPixel=function(a,b,c){var d;return d=this.coordinatesToLocation(a,b,this.width),this.c.pixelData[d]=c.r,this.c.pixelData[d+1]=c.g,this.c.pixelData[d+2]=c.b,this.c.pixelData[d+3]=c.a},a}(),r=function(){function a(){}return a.plugins={},a.register=function(a,b){return this.plugins[a]=b},a.execute=function(a,b,c){return this.plugins[b].apply(a,c)},a}(),e.Plugin=r,e.Renderer=s=function(){function a(b){var c=this;this.c=b,this.processNext=function(){return a.prototype.processNext.apply(c,arguments)},this.renderQueue=[],this.modPixelData=null}return a.Blocks=e.NodeJS?require("os").cpus().length:4,a.prototype.add=function(a){if(a==null)return;return this.renderQueue.push(a)},a.prototype.processNext=function(){var a;if(this.renderQueue.length===0)return i.trigger(this,"renderFinished"),this.finishedFn!=null&&this.finishedFn.call(this.c),this;this.currentJob=this.renderQueue.shift();switch(this.currentJob.type){case k.Type.LayerDequeue:return a=this.c.canvasQueue.shift(),this.c.executeLayer(a),this.processNext();case k.Type.LayerFinished:return this.c.applyCurrentLayer(),this.c.popContext(),this.processNext();case k.Type.LoadOverlay:return this.loadOverlay(this.currentJob.layer,this.currentJob.src);case k.Type.Plugin:return this.executePlugin();default:return this.executeFilter()}},a.prototype.execute=function(a){return this.finishedFn=a,this.modPixelData=v.dataArray(this.c.pixelData.length),this.processNext()},a.prototype.eachBlock=function(b){var c,d,f,g,h,i,k,l,m,n,o,p,q=this;this.blocksDone=0,l=this.c.pixelData.length,d=Math.floor(l/4/a.Blocks),c=d*4,k=c+l/4%a.Blocks*4,p=[];for(i=n=0,o=a.Blocks;0<=o?n<o:n>o;i=0<=o?++n:--n)m=i*c,g=m+(i===a.Blocks-1?k:c),e.NodeJS?(h=j(function(){return b.call(q,i,m,g)}),f=h.run(),p.push(this.blockFinished(f))):p.push(setTimeout(function(a,c,d){return function(){return b.call(q,a,c,d)}}(i,m,g),0));return p},a.prototype.executeFilter=function(){return i.trigger(this.c,"processStart",this.currentJob),this.currentJob.type===k.Type.Single?this.eachBlock(this.renderBlock):this.eachBlock(this.renderKernel)},a.prototype.executePlugin=function(){return o.debug("Executing plugin "+this.currentJob.plugin),r.execute(this.c,this.currentJob.plugin,this.currentJob.args),o.debug("Plugin "+this.currentJob.plugin+" finished!"),this.processNext()},a.prototype.renderBlock=function(b,c,d){var f,g,h,k,l;o.debug("Block #"+b+" - Filter: "+this.currentJob.name+", Start: "+c+", End: "+d),i.trigger(this.c,"blockStarted",{blockNum:b,totalBlocks:a.Blocks,startPixel:c,endPixel:d}),f={r:0,g:0,b:0,a:0},h=new q(this.c);for(g=l=c;l<d;g=l+=4)h.loc=g,f.r=this.c.pixelData[g],f.g=this.c.pixelData[g+1],f.b=this.c.pixelData[g+2],f.a=this.c.pixelData[g+3],k=this.currentJob.processFn.call(h,f),k.a==null&&(k.a=f.a),this.c.pixelData[g]=v.clampRGB(k.r),this.c.pixelData[g+1]=v.clampRGB(k.g),this.c.pixelData[g+2]=v.clampRGB(k.b),this.c.pixelData[g+3]=v.clampRGB(k.a);return e.NodeJS?j.yield(b):this.blockFinished(b)},a.prototype.renderKernel=function(a,b,c){var d,f,g,h,i,k,l,m,n,p,r,s,t,u,w,x,y,z;s=this.currentJob.name,g=this.currentJob.bias,k=this.currentJob.divisor,r=this.c.pixelData.length,d=this.currentJob.adjust,f=Math.sqrt(d.length),p=[],o.debug("Rendering kernel - Filter: "+this.currentJob.name),b=Math.max(b,this.c.dimensions.width*4*((f-1)/2)),c=Math.min(c,r-this.c.dimensions.width*4*((f-1)/2)),h=(f-1)/2,u=new q(this.c);for(l=x=b;x<c;l=x+=4){u.loc=l,i=0;for(m=y=-h;-h<=h?y<=h:y>=h;m=-h<=h?++y:--y)for(n=z=h;h<=-h?z<=-h:z>=-h;n=h<=-h?++z:--z)t=u.getPixelRelative(m,n),p[i*3]=t.r,p[i*3+1]=t.g,p[i*3+2]=t.b,i++;w=this.processKernel(d,p,k,g),this.modPixelData[l]=v.clampRGB(w.r),this.modPixelData[l+1]=v.clampRGB(w.g),this.modPixelData[l+2]=v.clampRGB(w.b),this.modPixelData[l+3]=this.c.pixelData[l+3]}return e.NodeJS?j.yield(a):this.blockFinished(a)},a.prototype.blockFinished=function(b){var c,d,e;b>=0&&o.debug("Block #"+b+" finished! Filter: "+this.currentJob.name),this.blocksDone++,i.trigger(this.c,"blockFinished",{blockNum:b,blocksFinished:this.blocksDone,totalBlocks:a.Blocks});if(this.blocksDone===a.Blocks){if(this.currentJob.type===k.Type.Kernel)for(c=d=0,e=this.c.pixelData.length;0<=e?d<e:d>e;c=0<=e?++d:--d)this.c.pixelData[c]=this.modPixelData[c];return b>=0&&o.debug("Filter "+this.currentJob.name+" finished!"),i.trigger(this.c,"processComplete",this.currentJob),this.processNext()}},a.prototype.processKernel=function(a,b,c,d){var e,f,g,h;f={r:0,g:0,b:0};for(e=g=0,h=a.length;0<=h?g<h:g>h;e=0<=h?++g:--g)f.r+=a[e]*b[e*3],f.g+=a[e]*b[e*3+1],f.b+=a[e]*b[e*3+2];return f.r=f.r/c+d,f.g=f.g/c+d,f.b=f.b/c+d,f},a.prototype.loadOverlay=function(a,b){var c,d,e=this;return c=document.createElement("img"),c.onload=function(){return a.context.drawImage(c,0,0,e.c.dimensions.width,e.c.dimensions.height),a.imageData=a.context.getImageData(0,0,e.c.dimensions.width,e.c.dimensions.height),a.pixelData=a.imageData.data,e.c.pixelData=a.pixelData,e.processNext()},d=l.remoteCheck(b),c.src=d!=null?d:b},a}(),e.Store=u=function(){function a(){}return a.items={},a.has=function(a){return this.items[a]!=null},a.get=function(a){return this.items[a]},a.put=function(a,b){return this.items[a]=b},a.execute=function(a,b){var c=this;return setTimeout(function(){return b.call(c.get(a),c.get(a))},0),this.get(a)},a.flush=function(a){return a==null&&(a=!1),a?delete this.items[a]:this.items={}},a}(),c.register("normal",function(a,b){return{r:a.r,g:a.g,b:a.b}}),c.register("multiply",function(a,b){return{r:a.r*b.r/255,g:a.g*b.g/255,b:a.b*b.b/255}}),c.register("screen",function(a,b){return{r:255-(255-a.r)*(255-b.r)/255,g:255-(255-a.g)*(255-b.g)/255,b:255-(255-a.b)*(255-b.b)/255}}),c.register("overlay",function(a,b){var c;return c={},c.r=b.r>128?255-2*(255-a.r)*(255-b.r)/255:b.r*a.r*2/255,c.g=b.g>128?255-2*(255-a.g)*(255-b.g)/255:b.g*a.g*2/255,c.b=b.b>128?255-2*(255-a.b)*(255-b.b)/255:b.b*a.b*2/255,c}),c.register("difference",function(a,b){return{r:a.r-b.r,g:a.g-b.g,b:a.b-b.b}}),c.register("addition",function(a,b){return{r:b.r+a.r,g:b.g+a.g,b:b.b+a.b}}),c.register("exclusion",function(a,b){return{r:128-2*(b.r-128)*(a.r-128)/255,g:128-2*(b.g-128)*(a.g-128)/255,b:128-2*(b.b-128)*(a.b-128)/255}}),c.register("softLight",function(a,b){var c;return c={},c.r=b.r>128?255-(255-b.r)*(255-(a.r-128))/255:b.r*(a.r+128)/255,c.g=b.g>128?255-(255-b.g)*(255-(a.g-128))/255:b.g*(a.g+128)/255,c.b=b.b>128?255-(255-b.b)*(255-(a.b-128))/255:b.b*(a.b+128)/255,c}),c.register("lighten",function(a,b){return{r:b.r>a.r?b.r:a.r,g:b.g>a.g?b.g:a.g,b:b.b>a.b?b.b:a.b}}),c.register("darken",function(a,b){return{r:b.r>a.r?a.r:b.r,g:b.g>a.g?a.g:b.g,b:b.b>a.b?a.b:b.b}}),k.register("fillColor",function(){var a;return arguments.length===1?a=h.hexToRGB(arguments[0]):a={r:arguments[0],g:arguments[1],b:arguments[2]},this.process("fillColor",function(b){return b.r=a.r,b.g=a.g,b.b=a.b,b.a=255,b})}),k.register("brightness",function(a){return a=Math.floor(255*(a/100)),this.process("brightness",function(b){return b.r+=a,b.g+=a,b.b+=a,b})}),k.register("saturation",function(a){return a*=-0.01,this.process("saturation",function(b){var c;return c=Math.max(b.r,b.g,b.b),b.r!==c&&(b.r+=(c-b.r)*a),b.g!==c&&(b.g+=(c-b.g)*a),b.b!==c&&(b.b+=(c-b.b)*a),b})}),k.register("vibrance",function(a){return a*=-1,this.process("vibrance",function(b){var c,d,e;return e=Math.max(b.r,b.g,b.b),d=(b.r+b.g+b.b)/3,c=Math.abs(e-d)*2/255*a/100,b.r!==e&&(b.r+=(e-b.r)*c),b.g!==e&&(b.g+=(e-b.g)*c),b.b!==e&&(b.b+=(e-b.b)*c),b})}),k.register("greyscale",function(a){return this.process("greyscale",function(a){var b;return b=d.luminance(a),a.r=b,a.g=b,a.b=b,a})}),k.register("contrast",function(a){return a=Math.pow((a+100)/100,2),this.process("contrast",function(b){return b.r/=255,b.r-=.5,b.r*=a,b.r+=.5,b.r*=255,b.g/=255,b.g-=.5,b.g*=a,b.g+=.5,b.g*=255,b.b/=255,b.b-=.5,b.b*=a,b.b+=.5,b.b*=255,b})}),k.register("hue",function(a){return this.process("hue",function(b){var c,d,e;return d=h.rgbToHSV(b.r,b.g,b.b),c=d.h*100,c+=Math.abs(a),c%=100,c/=100,d.h=c,e=h.hsvToRGB(d.h,d.s,d.v),e.a=b.a,e})}),k.register("colorize",function(){var a,b;return arguments.length===2?(b=h.hexToRGB(arguments[0]),a=arguments[1]):arguments.length===4&&(b={r:arguments[0],g:arguments[1],b:arguments[2]},a=arguments[3]),this.process("colorize",function(c){return c.r-=(c.r-b.r)*(a/100),c.g-=(c.g-b.g)*(a/100),c.b-=(c.b-b.b)*(a/100),c})}),k.register("invert",function(){return this.process("invert",function(a){return a.r=255-a.r,a.g=255-a.g,a.b=255-a.b,a})}),k.register("sepia",function(a){return a==null&&(a=100),a/=100,this.process("sepia",function(b){return b.r=Math.min(255,b.r*(1-.607*a)+b.g*.769*a+b.b*.189*a),b.g=Math.min(255,b.r*.349*a+b.g*(1-.314*a)+b.b*.168*a),b.b=Math.min(255,b.r*.272*a+b.g*.534*a+b.b*(1-.869*a)),b})}),k.register("gamma",function(a){return this.process("gamma",function(b){return b.r=Math.pow(b.r/255,a)*255,b.g=Math.pow(b.g/255,a)*255,b.b=Math.pow(b.b/255,a)*255,b})}),k.register("noise",function(a){return a=Math.abs(a)*2.55,this.process("noise",function(b){var c;return c=d.randomRange(a*-1,a),b.r+=c,b.g+=c,b.b+=c,b})}),k.register("clip",function(a){return a=Math.abs(a)*2.55,this.process("clip",function(b){return b.r>255-a?b.r=255:b.r<a&&(b.r=0),b.g>255-a?b.g=255:b.g<a&&(b.g=0),b.b>255-a?b.b=255:b.b<a&&(b.b=0),b})}),k.register("channels",function(a){var b,c;if(typeof a!="object")return this;for(b in a){if(!z.call(a,b))continue;c=a[b];if(c===0){delete a[b];continue}a[b]/=100}return a.length===0?this:this.process("channels",function(b){return a.red!=null&&(a.red>0?b.r+=(255-b.r)*a.red:b.r-=b.r*Math.abs(a.red)),a.green!=null&&(a.green>0?b.g+=(255-b.g)*a.green:b.g-=b.g*Math.abs(a.green)),a.blue!=null&&(a.blue>0?b.b+=(255-b.b)*a.blue:b.b-=b.b*Math.abs(a.blue)),b})}),k.register("curves",function(){var a,b,c,e,f,g,h,i,j,k,l,m;b=arguments[0],c=2<=arguments.length?B.call(arguments,1):[],typeof b=="string"&&(b=b.split("")),b[0]==="v"&&(b=["r","g","b"]);if(c.length<3||c.length>4)throw"Invalid number of arguments to curves filter";i=c[0],e=c[1],f=c.length===4?c[2]:c[1],g=c[c.length-1],a=d.bezier(i,e,f,g,0,255);if(i[0]>0)for(h=j=0,l=i[0];0<=l?j<l:j>l;h=0<=l?++j:--j)a[h]=i[1];if(g[0]<255)for(h=k=m=g[0];m<=255?k<=255:k>=255;h=m<=255?++k:--k)a[h]=g[1];return this.process("curves",function(c){var d,e;for(h=d=0,e=b.length;0<=e?d<e:d>e;h=0<=e?++d:--d)c[b[h]]=a[c[b[h]]];return c})}),k.register("exposure",function(a){var b,c,d;return d=Math.abs(a)/100,b=[0,255*d],c=[255-255*d,255],a<0&&(b=b.reverse(),c=c.reverse()),this.curves("rgb",[0,0],b,c,[255,255])}),e.Plugin.register("crop",function(a,b,c,d){var e,f;return c==null&&(c=0),d==null&&(d=0),typeof exports!="undefined"&&exports!==null?e=new g(a,b):(e=document.createElement("canvas"),v.copyAttributes(this.canvas,e),e.width=a,e.height=b),f=e.getContext("2d"),f.drawImage(this.canvas,c,d,a,b,0,0,a,b),this.cropCoordinates={x:c,y:d},this.cropped=!0,this.replaceCanvas(e)}),e.Plugin.register("resize",function(a){var b,c;a==null&&(a=null);if(a===null||a.width==null&&a.height==null){o.error("Invalid or missing dimensions given for resize");return}return a.width==null?a.width=this.canvas.width*a.height/this.canvas.height:a.height==null&&(a.height=this.canvas.height*a.width/this.canvas.width),typeof exports!="undefined"&&exports!==null?b=new g(a.width,a.height):(b=document.createElement("canvas"),v.copyAttributes(this.canvas,b),b.width=a.width,b.height=a.height),c=b.getContext("2d"),c.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,a.width,a.height),this.resized=!0,this.replaceCanvas(b)}),e.Filter.register("crop",function(){return this.processPlugin("crop",Array.prototype.slice.call(arguments,0))}),e.Filter.register("resize",function(){return this.processPlugin("resize",Array.prototype.slice.call(arguments,0))}),e.Filter.register("boxBlur",function(){return this.processKernel("Box Blur",[1,1,1,1,1,1,1,1,1])}),e.Filter.register("heavyRadialBlur",function(){return this.processKernel("Heavy Radial Blur",[0,0,1,0,0,0,1,1,1,0,1,1,1,1,1,0,1,1,1,0,0,0,1,0,0])}),e.Filter.register("gaussianBlur",function(){return this.processKernel("Gaussian Blur",[1,4,6,4,1,4,16,24,16,4,6,24,36,24,6,4,16,24,16,4,1,4,6,4,1])}),e.Filter.register("motionBlur",function(a){var b;return a===0||a===180?b=[0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0]:a>0&&a<90||a>180&&a<270?b=[0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0]:a===90||a===270?b=[0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0]:b=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1],this.processKernel("Motion Blur",b)}),e.Filter.register("sharpen",function(a){return a==null&&(a=100),a/=100,this.processKernel("Sharpen",[0,-a,0,-a,4*a+1,-a,0,-a,0])}),y={brightness:function(a,b,c){return a.r=a.r-a.r*b*c.strength,a.g=a.g-a.g*b*c.strength,a.b=a.b-a.b*b*c.strength,a},gamma:function(a,b,c){return a.r=Math.pow(a.r/255,Math.max(10*b*c.strength,1))*255,a.g=Math.pow(a.g/255,Math.max(10*b*c.strength,1))*255,a.b=Math.pow(a.b/255,Math.max(10*b*c.strength,1))*255,a},colorize:function(a,b,c){return a.r-=(a.r-c.color.r)*b,a.g-=(a.g-c.color.g)*b,a.b-=(a.b-c.color.b)*b,a}},k.register("vignette",function(a,b){var c,e,f,g;return b==null&&(b=60),typeof a=="string"&&a.substr(-1)==="%"&&(this.dimensions.height>this.dimensions.width?a=this.dimensions.width*(parseInt(a.substr(0,a.length-1),10)/100):a=this.dimensions.height*(parseInt(a.substr(0,a.length-1),10)/100)),b/=100,e=[this.dimensions.width/2,this.dimensions.height/2],g=Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)),f=g-a,c=d.bezier([0,1],[30,30],[70,60],[100,80]),this.process("vignette",function(g){var h,i,j;return j=this.locationXY(),h=d.distance(j.x,j.y,e[0],e[1]),h>f&&(i=Math.max(1,c[Math.round((h-f)/a*100)]/10*b),g.r=Math.pow(g.r/255,i)*255,g.g=Math.pow(g.g/255,i)*255,g.b=Math.pow(g.b/255,i)*255),g})}),k.register("rectangularVignette",function(a){var b,c,f,g,i,j,k;b={strength:50,cornerRadius:0,method:"brightness",color:{r:0,g:0,b:0}},a=v.extend(b,a);if(!a.size)return this;if(typeof a.size=="string")f=parseInt(a.size,10)/100,a.size={width:this.dimensions.width*f,height:this.dimensions.height*f};else if(typeof a.size=="object"){k=["width","height"];for(i=0,j=k.length;i<j;i++)c=k[i],typeof a.size[c]=="string"&&(a.size[c]=this.dimensions[c]*(parseInt(a.size[c],10)/100))}else a.size==="number"&&(g=a.size,a.size={width:g,height:g});return typeof a.cornerRadius=="string"&&(a.cornerRadius=a.size.width/2*(parseInt(a.cornerRadius,10)/100)),a.strength/=100,a.size.width=Math.floor(a.size.width),a.size.height=Math.floor(a.size.height),a.image={width:this.dimensions.width,height:this.dimensions.height},a.method==="colorize"&&typeof a.color=="string"&&(a.color=h.hexToRGB(a.color)),a.coords={left:(this.dimensions.width-a.size.width)/2,right:this.dimensions.width-a.coords.left,bottom:(this.dimensions.height-a.size.height)/2,top:this.dimensions.height-a.coords.bottom},a.corners=[{x:a.coords.left+a.cornerRadius,y:a.coords.top-a.cornerRadius},{x:a.coords.right-a.cornerRadius,y:a.coords.top-a.cornerRadius},{x:a.coords.right-a.cornerRadius,y:a.coords.bottom+a.cornerRadius},{x:a.coords.left+a.cornerRadius,y:a.coords.bottom+a.cornerRadius}],a.maxDist=d.distance(0,0,a.corners[3].x,a.corners[3].y)-a.cornerRadius,this.process("rectangularVignette",function(b){var c,d,f;return d=this.locationXY(),d.x>a.corners[0].x&&d.x<a.corners[1].x&&d.y>a.coords.bottom&&d.y<a.coords.top?b:d.x>a.coords.left&&d.x<a.coords.right&&d.y>a.corners[3].y&&d.y<a.corners[2].y?b:(d.x>a.corners[0].x&&d.x<a.corners[1].x&&d.y>a.coords.top?c=(d.y-a.coords.top)/a.maxDist:d.y>a.corners[2].y&&d.y<a.corners[1].y&&d.x>a.coords.right?c=(d.x-a.coords.right)/a.maxDist:d.x>a.corners[0].x&&d.x<a.corners[1].x&&d.y<a.coords.bottom?c=(a.coords.bottom-d.y)/a.maxDist:d.y>a.corners[2].y&&d.y<a.corners[1].y&&d.x<a.coords.left?c=(a.coords.left-d.x)/a.maxDist:d.x<=a.corners[0].x&&d.y>=a.corners[0].y?(f=e.distance(d.x,d.y,a.corners[0].x,a.corners[0].y),c=(f-a.cornerRadius)/a.maxDist):d.x>=a.corners[1].x&&d.y>=a.corners[1].y?(f=e.distance(d.x,d.y,a.corners[1].x,a.corners[1].y),c=(f-a.cornerRadius)/a.maxDist):d.x>=a.corners[2].x&&d.y<=a.corners[2].y?(f=e.distance(d.x,d.y,a.corners[2].x,a.corners[2].y),c=(f-a.cornerRadius)/a.maxDist):d.x<=a.corners[3].x&&d.y<=a.corners[3].y&&(f=e.distance(d.x,d.y,a.corners[3].x,a.corners[3].y),c=(f-a.cornerRadius)/a.maxDist),c<0?b:y[a.method](b,c,a))})}),function(){var a,b,c,d,f;return d=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],f=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],b=function(a,b,c,d,e,f,h){var i,j,k,l,m,n,o;return i=typeof exports!="undefined"&&exports!==null?new g:document.createElement("canvas"),i.width=a,i.height=b,l=c+Math.cos(e)*f*.5,n=d+Math.sin(e)*f*.5,m=c-Math.cos(e)*f*.5,o=d-Math.sin(e)*f*.5,j=i.getContext("2d"),k=j.createLinearGradient(l,n,m,o),h?(k.addColorStop(0,"white"),k.addColorStop(.5,"black"),k.addColorStop(1,"white")):(k.addColorStop(0,"white"),k.addColorStop(1,"black")),j.fillStyle=k,j.fillRect(0,0,a,b),j.getImageData(0,0,a,b)},c=function(a,b,c,d,e,f){var h,i,j;return h=typeof exports!="undefined"&&exports!==null?new g:document.createElement("canvas"),h.width=a,h.height=b,i=h.getContext("2d"),j=i.createRadialGradient(c,d,e,c,d,f),j.addColorStop(1,"white"),j.addColorStop(0,"black"),i.fillStyle=j,i.fillRect(0,0,a,b),i.getImageData(0,0,a,b)},a=function(){return this.r=0,this.g=0,this.b=0,this.a=0,this.next=null},e.Plugin.register("compoundBlur",function(b,c,e,g){var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,ab,bb,cb,db,eb,fb,gb,hb,ib,jb,kb;W=this.dimensions.width,q=this.dimensions.height,v=this.pixelData,I=b.data,U=W*q,V=U<<2,D=[];for(s=bb=0;0<=V?bb<V:bb>V;s=0<=V?++bb:--bb)D[s]=v[s];l=0,R=g,g-=1;while(R-->=0){x=c+.5|0;if(x===0)continue;x>256&&(x=256),m=x+x+1,T=W<<2,X=W-1,r=q-1,J=x+1,S=J*(J+1)/2,Q=new a,N=void 0,M=Q;for(s=cb=1;1<=m?cb<m:cb>m;s=1<=m?++cb:--cb)M=M.next=new a,s===J&&(N=M);M.next=Q,O=null,P=null,ab=$=0,z=d[x],L=f[x];for(Z=db=0;0<=q?db<q:db>q;Z=0<=q?++db:--db){F=n=h=H=p=j=0,G=J*(E=D[$]),o=J*(C=D[$+1]),i=J*(B=D[$+2]),H+=S*E,p+=S*C,j+=S*B,M=Q;for(s=eb=0;0<=J?eb<J:eb>J;s=0<=J?++eb:--eb)M.r=E,M.g=C,M.b=B,M=M.next;for(s=fb=1;1<=J?fb<J:fb>J;s=1<=J?++fb:--fb)A=$+((X<s?X:s)<<2),H+=(M.r=E=D[A])*(K=J-s),p+=(M.g=C=D[A+1])*K,j+=(M.b=B=D[A+2])*K,F+=E,n+=C,h+=B,M=M.next;O=Q,P=N;for(Y=gb=0;0<=W?gb<W:gb>W;Y=0<=W?++gb:--gb)D[$]=H*z>>L,D[$+1]=p*z>>L,D[$+2]=j*z>>L,H-=G,p-=o,j-=i,G-=O.r,o-=O.g,i-=O.b,A=ab+((A=Y+J)<X?A:X)<<2,F+=O.r=D[A],n+=O.g=D[A+1],h+=O.b=D[A+2],H+=F,p+=n,j+=h,O=O.next,G+=E=P.r,o+=C=P.g,i+=B=P.b,F-=E,n-=C,h-=B,P=P.next,$+=4;ab+=W}for(Y=hb=0;0<=W?hb<W:hb>W;Y=0<=W?++hb:--hb){n=h=F=p=j=H=0,$=Y<<2,G=J*(E=D[$]),o=J*(C=D[$+1]),i=J*(B=D[$+2]),H+=S*E,p+=S*C,j+=S*B,M=Q;for(s=ib=0;0<=J?ib<J:ib>J;s=0<=J?++ib:--ib)M.r=E,M.g=C,M.b=B,M=M.next;_=W;for(s=jb=1;1<=J?jb<J:jb>J;s=1<=J?++jb:--jb)$=_+Y<<2,H+=(M.r=E=D[$])*(K=J-s),p+=(M.g=C=D[$+1])*K,j+=(M.b=B=D[$+2])*K,F+=E,n+=C,h+=B,M=M.next,s<r&&(_+=W);$=Y,O=Q,P=N;for(Z=kb=0;0<=q?kb<q:kb>q;Z=0<=q?++kb:--kb)A=$<<2,D[A]=H*z>>L,D[A+1]=p*z>>L,D[A+2]=j*z>>L,H-=G,p-=o,j-=i,G-=O.r,o-=O.g,i-=O.b,A=Y+((A=Z+J)<r?A:r)*W<<2,H+=F+=O.r=D[A],p+=n+=O.g=D[A+1],j+=h+=O.b=D[A+2],O=O.next,G+=E=P.r,o+=C=P.g,i+=B=P.b,F-=E,n-=C,h-=B,P=P.next,$+=W}c*=e,s=U;while(--s>-1)u=s<<2,y=(I[u+2]&255)/255*g,w=y|0,w===l?(k=256*(y-(y|0)),t=256-k,v[u]=v[u]*t+D[u]*k>>8,v[u+1]=v[u+1]*t+D[u+1]*k>>8,v[u+2]=v[u+2]*t+D[u+2]*k>>8):w===l+1&&(v[u]=D[u],v[u+1]=D[u+1],v[u+2]=D[u+2]);l++}return this}),e.Filter.register("tiltShift",function(a){var c,d;return c={center:{x:this.dimensions.width/2,y:this.dimensions.height/2},angle:45,focusWidth:200,startRadius:3,radiusFactor:1.5,steps:3},a=v.extend(c,a),a.angle*=Math.PI/180,d=b(this.dimensions.width,this.dimensions.height,a.center.x,a.center.y,a.angle,a.focusWidth,!0),this.processPlugin("compoundBlur",[d,a.startRadius,a.radiusFactor,a.steps])}),e.Filter.register("radialBlur",function(a){var b,d,e,f;return b={size:50,center:{x:this.dimensions.width/2,y:this.dimensions.height/2},startRadius:3,radiusFactor:1.5,steps:3,radius:null},a=v.extend(b,a),a.radius||(a.radius=this.dimensions.width<this.dimensions.height?this.dimensions.height:this.dimensions.width),e=a.radius/2-a.size,f=a.radius/2,d=c(this.dimensions.width,this.dimensions.height,a.center.x,a.center.y,e,f),this.processPlugin("compoundBlur",[d,a.startRadius,a.radiusFactor,a.steps])})}(),e.Filter.register("edgeEnhance",function(){return this.processKernel("Edge Enhance",[0,0,0,-1,1,0,0,0,0])}),e.Filter.register("edgeDetect",function(){return this.processKernel("Edge Detect",[-1,-1,-1,-1,8,-1,-1,-1,-1])}),e.Filter.register("emboss",function(){return this.processKernel("Emboss",[-2,-1,0,-1,1,1,0,1,2])}),e.Filter.register("posterize",function(a){var b,c;return b=256/a,c=255/(a-1),this.process("posterize",function(a){return a.r=Math.floor(Math.floor(a.r/b)*c),a.g=Math.floor(Math.floor(a.g/b)*c),a.b=Math.floor(Math.floor(a.b/b)*c),a})}),e.Filter.register("vintage",function(a){a==null&&(a=!0),this.greyscale(),this.contrast(5),this.noise(3),this.sepia(100),this.channels({red:8,blue:2,green:4}),this.gamma(.87);if(a)return this.vignette("40%",30)}),e.Filter.register("lomo",function(a){return a==null&&(a=!0),this.brightness(15),this.exposure(15),this.curves("rgb",[0,0],[200,0],[155,255],[255,255]),this.saturation(-20),this.gamma(1.8),a&&this.vignette("50%",60),this.brightness(5)}),e.Filter.register("clarity",function(a){return a==null&&(a=!1),this.vibrance(20),this.curves("rgb",[5,0],[130,150],[190,220],[250,255]),this.sharpen(15),this.vignette("45%",20),a&&(this.greyscale(),this.contrast(4)),this}),e.Filter.register("sinCity",function(){return this.contrast(100),this.brightness(15),this.exposure(10),this.posterize(80),this.clip(30),this.greyscale()}),e.Filter.register("sunrise",function(){return this.exposure(3.5),this.saturation(-5),this.vibrance(50),this.sepia(60),this.colorize("#e87b22",10),this.channels({red:8,blue:8}),this.contrast(5),this.gamma(1.2),this.vignette("55%",25)}),e.Filter.register("crossProcess",function(){return this.exposure(5),this.colorize("#e87b22",4),this.sepia(20),this.channels({blue:8,red:3}),this.curves("b",[0,0],[100,150],[180,180],[255,255]),this.contrast(15),this.vibrance(75),this.gamma(1.6)}),e.Filter.register("orangePeel",function(){return this.curves("rgb",[0,0],[100,50],[140,200],[255,255]),this.vibrance(-30),this.saturation(-30),this.colorize("#ff9000",30),this.contrast(-5),this.gamma(1.4)}),e.Filter.register("love",function(){return this.brightness(5),this.exposure(8),this.contrast(4),this.colorize("#c42007",30),this.vibrance(50),this.gamma(1.3)}),e.Filter.register("grungy",function(){return this.gamma(1.5),this.clip(25),this.saturation(-60),this.contrast(5),this.noise(5),this.vignette("50%",30)}),e.Filter.register("jarques",function(){return this.saturation(-35),this.curves("b",[20,0],[90,120],[186,144],[255,230]),this.curves("r",[0,0],[144,90],[138,120],[255,255]),this.curves("g",[10,0],[115,105],[148,100],[255,248]),this.curves("rgb",[0,0],[120,100],[128,140],[255,255]),this.sharpen(20)}),e.Filter.register("pinhole",function(){return this.greyscale(),this.sepia(10),this.exposure(10),this.contrast(15),this.vignette("60%",35)}),e.Filter.register("oldBoot",function(){return this.saturation(-20),this.vibrance(-50),this.gamma(1.1),this.sepia(30),this.channels({red:-10,blue:5}),this.curves("rgb",[0,0],[80,50],[128,230],[255,255]),this.vignette("60%",30)}),e.Filter.register("glowingSun",function(a){a==null&&(a=!0),this.brightness(10),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(80),this.copyParent(),this.filter.gamma(.8),this.filter.contrast(50),this.filter.exposure(10)}),this.newLayer(function(){return this.setBlendingMode("softLight"),this.opacity(80),this.fillColor("#f49600")}),this.exposure(20),this.gamma(.8);if(a)return this.vignette("45%",20)}),e.Filter.register("hazyDays",function(){return this.gamma(1.2),this.newLayer(function(){return this.setBlendingMode("overlay"),this.opacity(60),this.copyParent(),this.filter.channels({red:5}),this.filter.stackBlur(15)}),this.newLayer(function(){return this.setBlendingMode("addition"),this.opacity(40),this.fillColor("#6899ba")}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(35),this.copyParent(),this.filter.brightness(40),this.filter.vibrance(40),this.filter.exposure(30),this.filter.contrast(15),this.filter.curves("r",[0,40],[128,128],[128,128],[255,215]),this.filter.curves("g",[0,40],[128,128],[128,128],[255,215]),this.filter.curves("b",[0,40],[128,128],[128,128],[255,215]),this.filter.stackBlur(5)}),this.curves("r",[20,0],[128,158],[128,128],[235,255]),this.curves("g",[20,0],[128,128],[128,128],[235,255]),this.curves("b",[20,0],[128,108],[128,128],[235,255]),this.vignette("45%",20)}),e.Filter.register("herMajesty",function(){return this.brightness(40),this.colorize("#ea1c5d",10),this.curves("b",[0,10],[128,180],[190,190],[255,255]),this.newLayer(function(){return this.setBlendingMode("overlay"),this.opacity(50),this.copyParent(),this.filter.gamma(.7),this.newLayer(function(){return this.setBlendingMode("normal"),this.opacity(60),this.fillColor("#ea1c5d")})}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(60),this.copyParent(),this.filter.saturation(50),this.filter.hue(90),this.filter.contrast(10)}),this.gamma(1.4),this.vibrance(-30),this.newLayer(function(){return this.opacity(10),this.fillColor("#e5f0ff")}),this}),e.Filter.register("nostalgia",function(){return this.saturation(20),this.gamma(1.4),this.greyscale(),this.contrast(5),this.sepia(100),this.channels({red:8,blue:2,green:4}),this.gamma(.8),this.contrast(5),this.exposure(10),this.newLayer(function(){return this.setBlendingMode("overlay"),this.copyParent(),this.opacity(55),this.filter.stackBlur(10)}),this.vignette("50%",30)}),e.Filter.register("hemingway",function(){return this.greyscale(),this.contrast(10),this.gamma(.9),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(40),this.copyParent(),this.filter.exposure(15),this.filter.contrast(15),this.filter.channels({green:10,red:5})}),this.sepia(30),this.curves("rgb",[0,10],[120,90],[180,200],[235,255]),this.channels({red:5,green:-2}),this.exposure(15)}),e.Filter.register("concentrate",function(){return this.sharpen(40),this.saturation(-50),this.channels({red:3}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(80),this.copyParent(),this.filter.sharpen(5),this.filter.contrast(50),this.filter.exposure(10),this.filter.channels({blue:5})}),this.brightness(10)}),function(){var a,b,c;return b=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],c=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],a=function(){return this.r=0,this.g=0,this.b=0,this.a=0,this.next=null},e.Plugin.register("stackBlur",function(d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W;if(isNaN(d)||d<1)return;d|=0,s=this.pixelData,H=this.dimensions.width,l=this.dimensions.height,h=d+d+1,G=H<<2,I=H-1,m=l-1,x=d+1,F=x*(x+1)/2,E=new a,A=E;for(n=O=1;1<=h?O<h:O>h;n=1<=h?++O:--O)A=A.next=new a,n===x&&(B=A);A.next=E,C=null,D=null,N=L=0,o=b[d],z=c[d];for(K=P=0;0<=l?P<l:P>l;K=0<=l?++P:--P){u=i=e=w=k=g=0,v=x*(t=s[L]),j=x*(r=s[L+1]),f=x*(q=s[L+2]),w+=F*t,k+=F*r,g+=F*q,A=E;for(n=Q=0;0<=x?Q<x:Q>x;n=0<=x?++Q:--Q)A.r=t,A.g=r,A.b=q,A=A.next;for(n=R=1;1<=x?R<x:R>x;n=1<=x?++R:--R)p=L+((I<n?I:n)<<2),w+=(A.r=t=s[p])*(y=x-n),k+=(A.g=r=s[p+1])*y,g+=(A.b=q=s[p+2])*y,u+=t,i+=r,e+=q,A=A.next;C=E,D=B;for(J=S=0;0<=H?S<H:S>H;J=0<=H?++S:--S)s[L]=w*o>>z,s[L+1]=k*o>>z,s[L+2]=g*o>>z,w-=v,k-=j,g-=f,v-=C.r,j-=C.g,f-=C.b,p=N+((p=J+d+1)<I?p:I)<<2,u+=C.r=s[p],i+=C.g=s[p+1],e+=C.b=s[p+2],w+=u,k+=i,g+=e,C=C.next,v+=t=D.r,j+=r=D.g,f+=q=D.b,u-=t,i-=r,e-=q,D=D.next,L+=4;N+=H}for(J=T=0;0<=H?T<H:T>H;J=0<=H?++T:--T){i=e=u=k=g=w=0,L=J<<2,v=x*(t=s[L]),j=x*(r=s[L+1]),f=x*(q=s[L+2]),w+=F*t,k+=F*r,g+=F*q,A=E;for(n=U=0;0<=x?U<x:U>x;n=0<=x?++U:--U)A.r=t,A.g=r,A.b=q,A=A.next;M=H;for(n=V=1;1<=d?V<=d:V>=d;n=1<=d?++V:--V)L=M+J<<2,w+=(A.r=t=s[L])*(y=x-n),k+=(A.g=r=s[L+1])*y,g+=(A.b=q=s[L+2])*y,u+=t,i+=r,e+=q,A=A.next,n<m&&(M+=H);L=J,C=E,D=B;for(K=W=0;0<=l?W<l:W>l;K=0<=l?++W:--W)p=L<<2,s[p]=w*o>>z,s[p+1]=k*o>>z,s[p+2]=g*o>>z,w-=v,k-=j,g-=f,v-=C.r,j-=C.g,f-=C.b,p=J+((p=K+x)<m?p:m)*H<<2,w+=u+=C.r=s[p],k+=i+=C.g=s[p+1],g+=e+=C.b=s[p+2],C=C.next,v+=t=D.r,j+=r=D.g,f+=q=D.b,u-=t,i-=r,e-=q,D=D.next,L+=H}return this}),e.Filter.register("stackBlur",function(a){return this.processPlugin("stackBlur",[a])})}(),e.Filter.register("threshold",function(a){return this.process("threshold",function(b){var c;return c=.2126*b.r+.7152*b.g+.0722*b.b,c<a?(b.r=0,b.g=0,b.b=0):(b.r=255,b.g=255,b.b=255),b})})}).call(this)