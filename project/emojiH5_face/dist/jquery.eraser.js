(function(a){typeof define=="function"&&define.amd!=undefined?define(["jquery","tomLib"],a):a(jQuery,!0)})(function(b,c){function d(a,b){var c=0;for(var d=0;d<a.width;d+=1)for(var e=0;e<a.height;e+=b.density)a.data[d*a.width*4+e*4+3]>0&&c++;return c}if(c===!0)var e=window.tomLib;var f=function(a,c){for(var d in c)this[d]=c[d];this.element=a,this.customCanvas?this.canvas=this.customCanvas:b(a).is("canvas")?this.canvas=a:this.canvas=b(a).find("canvas.eraser")[0],this.canvas==undefined&&(this.canvas=document.createElement("canvas"),this.container.appendChild(this.canvas),this.canvas.style.zIndex=f._zIndex++,this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.id="fingerEraser"+f.ID++,this.canvas.className="eraser"),this.customCanvas||(this.canvas.width=this.container.clientWidth,this.canvas.height=this.container.clientHeight),this.container?(this.viewHeight=this.container.clientHeight,this.viewWidth=this.container.clientWidth):(this.viewHeight=this.canvas.width,this.viewWidth=this.canvas.height);if(this.canvas.tagName!="CANVAS"&&!typeof this.canvas.getContext=="function"){console.log("浏览器不支持canvas或者传入了错误的canvas对象");return}this.ctx=this.canvas.getContext("2d")};f._zIndex=8888,f.ID=0,f.DEFAULTS={container:document.body,bindContainer:!1,customCanvas:!1,bgImage:null,bgColor:null,interval:100,scaleCanvas:1,noneedCalc:null,checkPng:!1,deviceRatio:window.devicePixelRatio||1,namespace:".eraser",alphaNoZeroNum:0,beforeInit:function(){console.log("初始化开始")},radius:30,density:1,percent:.5,success:function(){console.log("请添加回调函数")},clipMethod:"tapClip"},f.prototype.init=function(){var a=this,c;this.ctx.globalCompositeOperation="source-over",this.isStop=!1,this.bgColor&&(this.ctx.save(),this.ctx.fillStyle=this.bgColor,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore());if(this.imgList){c=new e.DeferredList(this.imgList.length);var f=[],g;for(var h=0,i=this.imgList.length;h<i;h++)(function(b){g=new Image,g.onload=function(){c.dealItem(b)},g.src=a.imgList[b].imgSrc,f.push(g),c.getItem(b).addCallbacks(function(){a.addImage(f[b],a.imgList[b].bgPos,a.imgList[b].bgScale,a.imgList[b].isCover)})})(h)}this.beforeInit(),this.checkPng&&(this.alphaNoZeroNum=d(this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),this)),b(document).off(this.namespace);if(this.ctxStyle)for(var j in this.ctxStyle)this.ctx[j]=this.ctxStyle[j];setTimeout(function(){a[a.clipMethod]()},100)},f.prototype.addImage=function(a,b,c,d){var e=1,f=0,g=c||1;a!=null&&(b!=undefined?(b={top:b.top||0,left:b.left||0},b.left=="center"&&(b.left=(this.viewWidth-a.width*g/this.deviceRatio)/2),b.top=="center"&&(b.top=(this.viewHeight-a.height*g/this.deviceRatio)/2),this.ctx.drawImage(a,0,0,a.width,a.height,b.left,b.top,a.width/this.deviceRatio*g,a.height/this.deviceRatio*g)):d==1?this.ctx.drawImage(a,0,0,this.viewWidth,this.viewHeight):a.width/a.height>this.canvas.width/this.canvas.height?(e=a.height/this.viewHeight,f=Math.abs((a.width-this.viewWidth*e)/2),this.ctx.drawImage(a,f,0,a.width-2*f,a.height,0,0,this.viewWidth,this.viewHeight)):a.width/a.height<this.canvas.width/this.canvas.height?(e=a.width/this.viewWidth,f=Math.abs((a.height-this.viewHeight*e)/2),this.ctx.drawImage(a,0,f,a.width,a.height-2*f,0,0,this.viewWidth,this.viewHeight)):this.ctx.drawImage(a,0,0,this.viewWidth,this.viewHeight))},f.prototype.stop=function(){this.isStop=!0},f.prototype.start=function(){this.isStop=!1},f.prototype.tapClip=function(){function a(a){if(!p||h.isStop)return;clearTimeout(k),a.preventDefault(),a=a.originalEvent;var b=c?a.targetTouches[0].clientX-q.left:a.clientX-(q.left-l.width/2*(h.scaleCanvas-1)),d=c?a.targetTouches[0].clientY-q.top:a.clientY-(q.top-l.height/2*(h.scaleCanvas-1));b/=h.scaleCanvas,d/=h.scaleCanvas,o.beginPath(),o.moveTo(i,j),o.lineTo(b,d),o.stroke(),o.closePath(),i=b,j=d}var c="ontouchstart"in window?!0:!1,e="touchstart mousedown",f="touchmove mousemove",g="touchend mouseup",h=this,i,j,k,l=h.canvas,m=h.namespace,n=!1,o=h.ctx,p=!1,q,r=b(l).prop("id"),s=this.bindContainer?b(this.container):"#"+r;o.lineCap="round",o.lineJoin="round",o.lineWidth=h.radius*2,b(document).delegate(s,e,function(a){clearTimeout(k),o.save();if(h.isStop)return;a=a.originalEvent,p=!0;if(h.every||!n&&h.type!="draw")o.globalCompositeOperation="destination-out",n=!0;q=l.getBoundingClientRect(),i=c?a.targetTouches[0].clientX-q.left:a.clientX-(q.left-l.width/2*(h.scaleCanvas-1)),j=c?a.targetTouches[0].clientY-q.top:a.clientY-(q.top-l.height/2*(h.scaleCanvas-1)),i/=h.scaleCanvas,j/=h.scaleCanvas}),b(document).delegate(s,f,a),b(document).delegate(s,g,function(){if(!p||h.isStop)return;p=!1,h.noneedCalc||(k=setTimeout(function(){var a=o.getImageData(0,0,l.width,l.height),b=d(a,h),c=a.width*a.height;h.checkPng&&(c=h.alphaNoZeroNum);var e=b/(c/(h.density*h.density));e<1-h.percent?h.success.call(h,l,o):console.log("剩余非空白区域"+e)},h.interval)),h.touchEndCb&&h.touchEndCb.call(h),o.restore()})},f.prototype.otherClip=function(){function c(b){b.preventDefault(),x2=d?b.targetTouches[0].pageX:b.clientX-l.offsetLeft,y2=d?b.targetTouches[0].pageY:b.clientY-l.offsetTop;var c=a*Math.sin(Math.atan((y2-j)/(x2-i))),e=a*Math.cos(Math.atan((y2-j)/(x2-i))),f=i+c,g=j-e,k=i-c,n=j+e,o=x2+c,p=y2-e,q=x2-c,r=y2+e;m.save(),m.beginPath(),m.arc(x2,y2,h.radius,0,2*Math.PI),m.clip(),m.clearRect(0,0,l.width,l.height),m.restore(),m.save(),m.beginPath(),m.moveTo(f,g),m.lineTo(o,p),m.lineTo(q,r),m.lineTo(k,n),m.closePath(),m.clip(),m.clearRect(0,0,l.width,l.height),m.restore(),i=x2,j=y2}var d="ontouchstart"in window,e=d?"touchstart":"mousedown",f=d?"touchmove":"mousemove",g=d?"touchend":"mouseup",h=this,i,j,k,l=h.canvas,m=h.ctx;b(l).on(e,function(a){clearTimeout(k),a.preventDefault(),a=a.originalEvent,i=d?a.targetTouches[0].pageX:a.clientX-l.offsetLeft,j=d?a.targetTouches[0].pageY:a.clientY-l.offsetTop,m.save(),m.beginPath(),m.arc(i,j,h.radius,0,2*Math.PI),m.clip(),m.clearRect(0,0,l.width,l.height),m.restore()}),b(l).on(f,c),b(l).on(g,function(){h.noneedCalc&&setTimeout(function(){m.fillStyle="white",m.fillRect(0,0,1,1),m.fillStyle="black",m.fillRect(1,1,2,2);var a=m.getImageData(0,0,l.width,l.height),b;b/(a.width*a.height/(h.density*h.density))<h.percent&&h.success.call(h,l,m)},h.interval)})},b.fn.eraser=function(a,c){return this.each(function(){var d=b(this),e=b(this).data("style.eraser"),g=b.extend({},f.DEFAULTS,typeof a=="object"&&a);e||d.data("style.eraser",e=new f(this,g));var h=typeof a=="string"?a:"init";h&&e[h](c)})},b.fn.eraser.Constructor=f;var g=b.fn.eraser;return b.fn.eraser.noConflict=function(){return b.fn.eraser=g,this},b})