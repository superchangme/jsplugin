<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="../css/page-common.css">
    <link rel="stylesheet" href="../bower_components/font-awesome/css/font-awesome.min.css"/>
    <title></title>
    <style>
        *{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html{
            height: 100%;
        }
        body{
            background: skyblue;
        }
        body{
            height: 100%;
            position: relative;
        }
        .app{
            height: 100%;
            position: absolute;
            display: none;
            top:0;
            left:0;
            right:0;
            bottom: 0;
        }
        .bar{
            height: 50px;
            padding: 10px;
            line-height: 30px;
            position: relative;
            z-index: 999;
        }
        .main{
           position: absolute;
            top:30px;
            bottom: 0;
            left:0;
            right: 0;
        }
        .upload-mask{
            height: 100%;
            width: 100%;
            position: absolute;
            z-index: 2;
        }
        .bar{
            color: white;
            background: darkslategrey;
        }
        .photo-canvas{
            width: 260px;
            height: 260px;
            position: absolute;
            top:50%;
            left:50%;
            border: 1px solid black;
            -webkit-transform: translate3d(-50%,-50%,0);
            transform: translate3d(-50%,-50%,0);
            z-index: 3;
        }
        #preview{
            max-width: 400px;
            max-height: 400px;
            display: block;
            z-index: 1;
        }
        #previewResult{
            background: #fff;
            border: 1px solid black;
        }
        .preview-box{
            position: absolute;
            top:50%;
            left:50%;
            -webkit-transform: translate3d(-50%,-50%,0);
            transform: translate3d(-50%,-50%,0);
        }
        body{
            overflow: hidden;
        }
        #getFile{
            color: #fef4e9;
            border: solid 1px #da7c0c;
            background: #f78d1d;
            vertical-align: middle;
            padding: 6px 5px;
            line-height: 1;
            background: -webkit-gradient(linear, left top, left bottom, from(#faa51a), to(#f47a20));
            background: -moz-linear-gradient(top, #faa51a, #f47a20);
            filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#faa51a', endColorstr='#f47a20');
        }
        #rotate{
            position: absolute;
            z-index: 5;
            bottom: 30px;
        }
    </style>
</head>
<body>
    <input type="file" id="file" accept="image/*" capture=camera"/>
     <img id="previewResult"/>
<div class="app" id="uploadPage">
  <div class="bar"><a class="back pull-left" id="closeCrop"><i class="fa fa-reply"></i></a><a id="getFile" class="pull-right">使用</a></div>
    <div class="main">
        <canvas class="upload-mask">

        </canvas>
        <div class="preview-box">
            <img id="preview"/>
        </div>
        <canvas class="photo-canvas">

        </canvas>
        <button id="rotate">rotate</button>
    </div>
</div>
</body>
<script src="../vendor/require.js" ></script>
<script src="../vendor/main.js"></script>
<script>
    var myCrop;
    require(["jQuery",'hammer','tomPlugin',"tomLib",'hammer.fake','hammer.showtouch'],function($,hammer,plugin,T){
        document.addEventListener("touchmove",function(e){
            e.preventDefault();
        })
        var $rotate=$("#rotate"),$file=$("#file"),previewStyle={x:0,y:0,scale:1,rotate:0},transform= T.prefixStyle("transform"),$previewResult=$("#previewResult"),$getFile=$("#getFile"),$preview=$("#preview"),$uploadPage=$("#uploadPage"),$mask=$(".upload-mask"),maskCtx=$mask[0].getContext("2d");

        myCrop=T.cropImage({
            bindFile:$file,
            canvas:$(".photo-canvas")[0],
            cropWidth:260,
            cropHeight:260,
            bindPreview:$preview,
            useHammer:true,
            oninit:function(){

            },
            onLoad:function(data){
                $preview.attr("src",data.originSrc).css({width:data.width,height:data.height});
                $(".photo-canvas").hammer('reset');
            }
        });
        $(".photo-canvas").hammer({
            gestureCb:function(o){
                $.extend(previewStyle,o);
                $preview.css(transform,"translate3d("+ previewStyle.x+'px,'+ previewStyle.y+"px,0) rotate("+previewStyle.rotate+"deg) scale("+previewStyle.scale+")")
            }
        })
        $getFile.on("click",function(){
            $uploadPage.hide();
            myCrop.setCropStyle(previewStyle)
            $previewResult.attr("src",myCrop.getCropFile())
        })
        $(document).delegate("#file","click",function(){
            $uploadPage.show();
        }).delegate("#closeCrop","click",function(){
            $uploadPage.hide();
            $(".photo-canvas").hammer('reset');
            previewStyle={scale:1,x:0,y:0,rotate:0};
            myCrop.setCropStyle(previewStyle)
            $previewResult.attr("src",'');
            $preview.attr("src",'')
        })
        $file.one("click",function(){
            $uploadPage.show();
            $mask.prop({width:$mask.width(),height:$mask.height()})
            maskCtx.fillStyle="rgba(0,0,0,0.7)";
            maskCtx.fillRect(0,0,$mask.width(),$mask.height());
            maskCtx.fill();
            maskCtx.clearRect(($mask.width()-260)/2,($mask.height()-260)/2,260,260)
        })
        $rotate.on("click",function(){
            previewStyle.rotate+=90
            if(previewStyle.rotate>360){
                previewStyle=90
            }
            myCrop.setCropStyle(previewStyle)

            $preview.css(transform,"translate3d("+ previewStyle.x+'px,'+ previewStyle.y+"px,0) rotate("+previewStyle.rotate+"deg) scale("+previewStyle.scale+")")

        })
    })
</script>
</html>