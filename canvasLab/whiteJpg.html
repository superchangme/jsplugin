<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />

    <title></title>
    <style>
        body{
            background: yellow;
        }
        canvas{
            width: 300px;
            height: 300px;
        }
    </style>
</head>
<body>
<input type="file" id="myFile"/>
     <canvas id="canvas" width="300" height="300"></canvas>

     <div></div>拖我调节
<input type="range" max="250" min="0" style="width: 200px" step="1" value="0" id="myRange"/>
<img id="previewMe"/>
</body>
<script src="../vendor/caman.js"></script>
<script src="../vendor/require.js" ></script>
<script src="../vendor/main.js"></script>
<script>
    Caman.Filter.register("sharpen", function(amt) {
        if (amt == null) {
            amt = 100;
        }
        amt /= 100;
        return this.processKernel("Sharpen", [0, -amt, 0, -amt, 4 * amt + 1, -amt, 0, -amt, 0]);
    });
    window.onerror=function(err){
        alert(err)
    }
   /* Caman.Filter.register("clip", function (F) {
        F = Math.abs(F) * 2.55;
        return this.process("clip", function (G) {
            if (G.r > 255 - F) {
                G.r = 255
            } else {
                if (G.r < F) {
                    G.r = 0
                }
            }
            if (G.g > 255 - F) {
                G.g = 255
            } else {
                if (G.g < F) {
                    G.g = 0
                }
            }
            if (G.b > 255 - F) {
                G.b = 255
            } else {
                if (G.b < F) {
                    G.b = 0
                }
            }
            return G
        })
    });*/
   var CantonImg;

   require(["jquery","tomLib"],function($,T){
       var $preview=$("#previewMe"),_oData,img=new Image,canvas=document.getElementById("canvas"),$range=$("#myRange"),$myFile=$("#myFile"),_canvas;
       if(window.CanvasPixelArray) {
           CanvasPixelArray.prototype.set = function(arr) {
               var l=this.length, i=0;

               for(;i<l;i++) {
                   this[i] = arr[i];
               }
           };
       }
       function copyImageData(ctx, src)
       {
           var dst = ctx.createImageData(src.width, src.height);
           dst.data.set(src.data);
           return dst;
       }
       function canvasImg(val){
           var data;
           if(!_oData){
               _oData=copyImageData(canvas.getContext("2d"),canvas.getContext("2d").getImageData(0,0,canvas.width,canvas.height))
           }
           data=copyImageData(canvas.getContext("2d"),_oData);
           var len=data.data.length;
           for(var i=0;i<len;i+=4){
               if(data.data[i]>val&&data.data[i+1]>val&&data.data[i+2]>val){
                   //黑色
                   data.data[i+3]=0;
               }
           }
           canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height)
           //canvas.getContext("2d").fillStyle="yellow";
           // canvas.getContext("2d").fill();
           canvas.getContext("2d").putImageData(data,0,0)
       }

       function fileToSrc(srcImage){
           var t=new FileReader;
           t.readAsDataURL(srcImage);
           t.onload=function(){
               t.result;
           }
           t.onerror=function(){
               alert("read file error")
           }
       }
       function loadImg(img){
           var defer= $.Deferred();
           $(canvas).removeAttr("data-caman-id");
           CantonImg=Caman("#canvas", img,function(){
               console.time("t")
              defer.resolve();
           });
           defer.done(function(){
               console.timeEnd("t")
               CantonImg.brightness(5).saturation(-100).clip(15).contrast(10)/*.sharpen(6)*/.noise(4).render(function(){
                   canvasImg(204);
               });
           })

       }
       $range.on("change",function(){
           canvasImg($(this).val())
       })
       $myFile.on("change",function(){
           _oData=null;
           T.cropImage(this.files[0],300,300).then(function(imgSrc){
               loadImg(imgSrc);
               $preview.attr("src",imgSrc)
           })

       })
   })

</script>
</html>